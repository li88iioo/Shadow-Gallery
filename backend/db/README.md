# 多数据库架构说明（单容器部署适配）

## 概述

本项目采用多 SQLite 数据库架构，以提高并发性能、减少锁冲突，并实现更好的数据分离。

在单容器部署（All-in-One）中，所有数据库文件默认保存在容器内 `/app/data`（可通过卷挂载持久化）。

## 数据库分布

### 1. 主数据库 (`gallery.db`)
- **用途**: 存储图片和视频的索引信息
- **表结构**:
  - `items`: 媒体文件索引
  - `items_fts`: 全文搜索索引
  - `album_covers`: 相册封面缓存（路径/尺寸/mtime）
  - `thumb_status`: 缩略图状态跟踪（exists/pending/failed/last_checked）
  - `migrations`: 数据库迁移记录

### 2. 设置数据库 (`settings.db`)
- **用途**: 存储应用配置设置
- **表结构**:
  - `settings`: 键值对配置存储
  - `migrations`: 数据库迁移记录

### 3. 历史记录数据库 (`history.db`)
- **用途**: 存储用户浏览历史
- **表结构**:
  - `view_history`: 用户查看历史记录
  - `migrations`: 数据库迁移记录

### 4. 索引数据库 (`index.db`)
- **用途**: 存储索引处理状态和队列
- **表结构**:
  - `index_status`: 索引处理状态
  - `index_queue`: 索引处理队列
  - `index_progress`: 全量/增量进度（断点续跑）
  - `migrations`: 数据库迁移记录

## 架构优势

### 1. 并发性能提升
- 不同功能模块使用独立数据库，避免锁冲突
- 设置更新不再阻塞索引重建
- 历史记录更新不影响搜索功能

### 2. 数据隔离
- 配置数据与业务数据分离
- 历史记录独立存储，便于清理和维护
- 索引状态独立管理

### 3. 扩展性
- 每个数据库可以独立优化
- 便于未来功能扩展
- 支持不同数据库类型的选择

### 4. 维护性
- 数据库文件更小，备份更快
- 问题定位更精确
- 数据迁移更灵活

## 技术实现

### 启动与连接管理
- 使用 `multi-db.js` 统一管理所有数据库连接
- 启动顺序（见 `backend/server.js`）：
  1) 创建/权限检查数据与缩略图目录
  2) 判断是否需要从单库迁移至多库（缺失则迁移，否则跳过）
  3) `initializeConnections()` 建立四库连接
  4) `initializeAllDBs()` 初始化迁移（若已完成则跳过）
  5) `ensureCoreTables()` 兜底创建关键表（幂等）
  6) 启动 Workers、搭建监听与索引/缩略图自愈

### 迁移系统
- 每个数据库独立的迁移记录
- 支持版本控制和回滚
- 自动执行未完成的迁移
- 自 1.0 起：仅当检测到多库文件缺失时才触发一次性迁移，避免重复迁移导致的锁冲突

### Worker架构
- 每个Worker使用对应的数据库
- 避免跨数据库事务
- 提高并发处理能力

## 数据迁移

### 自动迁移
系统启动时自动检测并在需要时执行：
1. 备份原有单库（若存在）
2. 创建四个数据库文件
3. 迁移设置/历史/索引状态等数据
4. 验证数据完整性并记录迁移标记

### 手动迁移
如需手动执行迁移，可在项目根目录运行：
```bash
node backend/db/migrate-to-multi-db.js
```

## 配置说明

### 环境变量
```bash
# 数据目录（容器内默认 /app/data）
DATA_DIR=/path/to/data

# 照片目录（容器内默认 /app/photos，仅用于扫描索引，不在此 README 展开）
PHOTOS_DIR=/path/to/photos

# 数据库文件会自动创建在以下位置：
# - $DATA_DIR/gallery.db   (主数据库)
# - $DATA_DIR/settings.db  (设置数据库)
# - $DATA_DIR/history.db   (历史记录数据库)
# - $DATA_DIR/index.db     (索引数据库)
```

### 数据库配置
每个数据库都配置了以下优化参数：
- `PRAGMA journal_mode = WAL`: 写前日志模式
- `PRAGMA synchronous = NORMAL`: 同步级别
- `PRAGMA cache_size = -8000`: 8MB缓存
- `PRAGMA busy_timeout = 10000`: 10秒超时

## 监控和维护

### 日志与维护
- 每个数据库操作包含库标识，便于排查
- 容器启动脚本会注册 `scripts/maintenance.js` 的定时任务（周期清理/维护）

### 性能监控
- 连接状态/查询性能/锁等待时间可通过日志与自定义指标导出

### 备份策略
- 四库独立备份（建议离线备份 `data/` 目录）
- 可结合宿主机定时任务或外部备份系统

## 故障处理

### 常见问题
1. **数据库锁定**: 确保 WAL 模式、适度增加超时时间
2. **连接失败**: 检查文件权限，重启服务
3. **数据不一致**: 使用迁移脚本重新同步或触发全量重建索引

### 恢复步骤
1. 停止服务
2. 备份当前 `data/` 目录
3. 运行迁移脚本（如需要）或清理异常数据
4. 重启服务，观察日志并验证完整性

## 未来规划

### 短期优化
- 添加数据库连接池
- 实现读写分离
- 优化查询性能

### 长期规划
- 支持PostgreSQL等关系型数据库
- 实现分布式数据库架构
- 添加数据压缩和加密

## 注意事项

1. **首次启动**: 若照片量大，迁移/索引构建与缩略图补齐可能耗时较长
2. **备份**: 建议定期备份所有数据库文件
3. **权限**: 确保应用对数据目录有读写权限
4. **磁盘空间**: 多数据库会占用更多磁盘空间
5. **兼容性**: 新架构向后兼容；建议在大版本升级后执行一次索引检查/必要时重建